<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SKY ANALYZER - Pn Edition</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./logo_ciel.png">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { 
            --bg: #f2f2f7; --card: #ffffff; --text: #000000; --border: #d1d1d6; --sub: #636366;
            --accent: #0a84ff; --green: #34c759; --orange: #ff9f0a; --red: #ff3b30; --overlay: rgba(255,255,255,0.95);
        }
        
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); color: var(--text); font-family: -apple-system, system-ui, sans-serif; overflow-x: hidden; }
        .app-container { display: flex; flex-direction: column; padding: 15px; max-width: 600px; margin: 0 auto; min-height: 100vh; box-sizing: border-box; }
        
        /* HEADER 80% - STRICT */
        .app-header-container { text-align: center; padding: 10px 0; border-bottom: 2px solid var(--accent); margin: 0 auto 20px auto; width: 80%; }
        .app-title { letter-spacing: 2px; font-size: 22px; font-weight: 900; color: var(--accent); text-transform: uppercase; margin: 0; }
        .pn-edition-sub { font-size: 10px; color: var(--sub); letter-spacing: 3px; text-transform: uppercase; font-weight: bold; margin-top: 2px; display: block; }
        
        .tabs { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        .tab-btn { background: none; border: none; color: var(--sub); font-weight: bold; cursor: pointer; padding: 8px 15px; font-size: 0.8rem; border-radius: 20px; }
        .tab-btn.active { background: var(--accent); color: white; }

        /* DESIGN CASES BLANCHES */
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 15px; text-align: center; color: var(--text); margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .stat-box { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 10px; text-align: center; }
        .stat-label { font-size: 10px; color: var(--accent); font-weight: 800; text-transform: uppercase; display: block; margin-bottom: 4px; }
        .stat-val { font-size: 14px; font-weight: 900; }

        #map-container { height: 300px; position: relative; border-radius: 16px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 15px; }
        #map { width: 100%; height: 100%; background: #ddd; z-index: 1; }
        
        .search-overlay { position: absolute; top: 10px; left: 10px; z-index: 1001; display: flex; width: calc(100% - 80px); gap: 5px; }
        .search-input { flex: 1; padding: 8px 12px; border-radius: 10px; border: 1px solid var(--border); font-size: 12px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .search-btn { background: var(--accent); color: white; border: none; padding: 8px 12px; border-radius: 10px; cursor: pointer; }

        .compass-box { position: absolute; top: 10px; right: 10px; z-index: 1000; width: 50px; height: 50px; background: var(--overlay); border-radius: 50%; border: 2px solid var(--accent); display: flex; align-items: center; justify-content: center; }
        .wind-needle { position: absolute; width: 4px; height: 30px; top: 10px; left: 23px; transition: transform 0.5s ease; display: flex; flex-direction: column; align-items: center; z-index: 10; }

        .map-btn { position: absolute; z-index: 1000; background: var(--accent); color: white; border: none; padding: 8px 12px; border-radius: 8px; font-size: 10px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-radar { bottom: 10px; right: 10px; }
        .btn-check { bottom: 10px; left: 10px; background: var(--green); }

        /* CHECKLIST MODAL */
        #checklist-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 90%; max-width: 450px; border-radius: 20px; padding: 20px; max-height: 85vh; overflow-y: auto; }
        .check-group-title { font-size: 11px; color: var(--accent); font-weight: 900; margin: 15px 0 5px 0; text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 4px; }
        .check-item { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid #f9f9f9; font-weight: 700; color: black; font-size: 13px; }
        .check-item input { width: 18px; height: 18px; }

        /* MISSION TERMINAL */
        .btn-launch-grid { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
        .btn-launch { width: 100%; padding: 18px; border-radius: 14px; font-weight: 900; cursor: pointer; text-transform: uppercase; font-size: 11px; border: 2px solid var(--accent); background: white; color: black; }

        .forecast-3h { display: flex; justify-content: space-around; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        .week-row { display: grid; grid-template-columns: 1.5fr 1fr 1fr; align-items: center; padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.9rem; font-weight: 900; }
        
        input[type=range] { width: 100%; accent-color: var(--accent); margin: 10px 0; }
        #page-week, #page-aero { display: none; }
    </style>
</head>
<body onload="initApp()">

<div id="checklist-modal">
    <div class="modal-content">
        <h2 style="text-align:center; color: var(--accent); font-size: 18px; margin-top:0;">CHECKLIST TACTIQUE</h2>
        <div class="check-group-title">Administratif & L√©gal</div>
        <div class="check-item"><input type="checkbox"> ‚öñÔ∏è AUTORISATION PR√âFET / MAGISTRAT</div>
        <div class="check-item"><input type="checkbox"> üß± GESTIONNAIRES SOL (ACC√àS)</div>
        <div class="check-item"><input type="checkbox"> üõ∞Ô∏è GESTIONNAIRES A√âRIENS (COORD)</div>
        <div class="check-group-title">V√©rifications Techniques</div>
        <div class="check-item"><input type="checkbox"> üîã BATTERIES CHARG√âES</div>
        <div class="check-item"><input type="checkbox"> üõ∞Ô∏è GPS FIX (>10 SATS)</div>
        <div class="check-item"><input type="checkbox"> üíæ CARTE SD INS√âR√âE</div>
        <div class="check-item"><input type="checkbox"> üöÅ H√âLICES / SERRAGE</div>
        <div class="check-item"><input type="checkbox"> üì° RADIO / VID√âO OK</div>
        <button onclick="toggleChecklist()" style="width:100%; margin-top:20px; padding:18px; background:var(--green); color:white; border:none; border-radius:12px; font-weight:900;">VALIDER & FERMER</button>
    </div>
</div>

<div class="app-container">
    <div class="app-header-container">
        <h1 class="app-title">SKY ANALYZER</h1>
        <span class="pn-edition-sub">Pn Edition</span>
        <div class="tabs">
            <button id="btn-now" class="tab-btn active" onclick="showPage('now')">DIRECT</button>
            <button id="btn-week" class="tab-btn" onclick="showPage('week')">7 JOURS</button>
            <button id="btn-aero" class="tab-btn" onclick="showPage('aero')">MISSION</button>
            <button onclick="fetchWeatherData()" style="background:none; border:none; cursor:pointer;">üîÑ</button>
        </div>
    </div>

    <div id="page-now">
        <div id="status-card" class="card" style="border-left: 10px solid var(--green); display: flex; align-items: center; justify-content: center; min-height: 80px;">
            <div id="status-txt" style="font-weight: 900; font-size: 28px; color: var(--green); text-align: center;">üõ°Ô∏è OP√âRATIONNEL</div>
        </div>

        <div class="stats-grid">
            <div class="stat-box"><span class="stat-label">Pt Ros√©e</span><span id="dp-val" class="stat-val">--</span></div>
            <div class="stat-box"><span class="stat-label">Prob. Pluie</span><span id="rain-prob" class="stat-val">--</span></div>
            <div class="stat-box"><span class="stat-label">Humidit√©</span><span id="hum-val" class="stat-val">--</span></div>
        </div>

        <div id="map-container">
            <div class="search-overlay">
                <input type="text" id="search-input" class="search-input" placeholder="Lieu de mission...">
                <button class="search-btn" onclick="searchAddress()">üîç</button>
            </div>
            <div id="map"></div>
            <div class="compass-box">
                <div id="compass-body" style="position:relative; width:100%; height:100%;"><span style="position:absolute; top:2px; left:50%; transform:translateX(-50%); font-size:9px; font-weight:900; color:var(--red);">N</span></div>
                <div id="wind-needle" class="wind-needle"><div style="width:0; height:0; border-left:4px solid transparent; border-right:4px solid transparent; border-bottom:10px solid var(--accent); margin-bottom:-2px;"></div><div style="width:2px; height:18px; background:var(--accent);"></div></div>
            </div>
            <button id="radar-btn-ui" class="map-btn btn-radar" onclick="toggleRadar()">üì° Radar</button>
            <button class="map-btn btn-check" onclick="toggleChecklist()">üìã Checklist</button>
        </div>

        <div class="card">
            <span class="stat-label">Altitude d'analyse : <b id="h-label">0</b>m</span>
            <input type="range" id="h-slider" min="0" max="250" value="0" step="5" oninput="runAnalysis()">
            <div id="v-alt-display">
                <div style="font-size: 32px; font-weight: 900;" id="v-alt-val">-- km/h</div>
                <div style="font-size: 16px; font-weight: 800;" id="v-gust-val">Rafales: -- km/h</div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-box"><span class="stat-label">Plafond</span><span id="cloud-base" class="stat-val">--</span></div>
            <div class="stat-box"><span class="stat-label">Visibilit√©</span><span id="visibility-val" class="stat-val">--</span></div>
            <div class="stat-box"><span class="stat-label">Indice KP</span><span id="kp-val" class="stat-val">1.2</span></div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-around; align-items:center; padding-bottom:10px;">
                <div><span id="main-weather-icon" style="font-size: 32px;">‚òÄÔ∏è</span><div style="font-size: 22px; font-weight: 900;"><span id="main-temp-val">--</span>¬∞C</div></div>
                <div style="width: 1px; height: 40px; background: var(--border);"></div>
                <div><div style="font-size: 22px; font-weight: 900;"><span id="pressure-val">--</span> <span id="pressure-trend">‚Üí</span></div><span class="stat-label">hPa (QFE)</span></div>
            </div>
            <div id="forecast-3h" class="forecast-3h"></div>
        </div>
    </div>

    <div id="page-week"><div class="card" style="padding:10px;"><div id="week-container"></div></div></div>

    <div id="page-aero">
        <div class="card">
            <h2 style="font-size: 14px; color: var(--accent); margin-bottom: 15px; text-transform: uppercase;">TERMINAL DE MISSION</h2>
            <div class="btn-launch-grid">
                <button class="btn-launch" onclick="openExternalGouv()">üó∫Ô∏è VISUALISEUR OACI (CARTE.GOUV.FR)</button>
                <button class="btn-launch" onclick="openExternalVAC()">üìë VISUALISEUR CARTE VAC</button>
                <button class="btn-launch" onclick="openExternalNOTAM()">‚ö†Ô∏è NOTAM</button>
                <button class="btn-launch" onclick="openExternalSUP()">üìÑ SUP AIP (SIA)</button>
                <button class="btn-launch" onclick="openExternalAZBA()">‚ö° VISUALISEUR RTBA / AZBA</button>
                <button class="btn-launch" onclick="openExternalCarto()">üóº CARTORADIO</button>
                <button class="btn-launch" onclick="openExternalOpenAIP()">üåê CONSULTATION ESPACES A√âRIENS</button>
            </div>
        </div>
    </div>
    <footer style="text-align:center; font-size:9px; color:var(--sub); padding: 20px;">¬© 2026 SKY ANALYZER - PN EDITION</footer>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let map, marker, radarLayer = null;
    let currentData = { vSol:0, gSol:0, windDir:0, tSol:0, humSol:0 };
    const wIcons = { 0:"‚òÄÔ∏è", 1:"üå§Ô∏è", 2:"‚õÖ", 3:"‚òÅÔ∏è", 45:"üå´Ô∏è", 51:"üå¶Ô∏è", 61:"üåßÔ∏è", 80:"üåßÔ∏è", 95:"‚õàÔ∏è" };

    function initApp() {
        map = L.map('map', { zoomControl: false, attributionControl: false }).setView([43.83, 4.36], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        marker = L.circleMarker([43.83, 4.36], { color: '#0a84ff', radius: 6, fillOpacity: 1, fillColor: 'white' }).addTo(map);
        initLocation();
    }

    async function searchAddress() {
        const query = document.getElementById('search-input').value;
        if (!query) return;
        try {
            const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
            const res = await resp.json();
            if (res.length > 0) {
                const p = [parseFloat(res[0].lat), parseFloat(res[0].lon)];
                marker.setLatLng(p); map.setView(p, 13); fetchWeatherData();
            }
        } catch (e) { console.error(e); }
    }

    async function fetchWeatherData() {
        const pos = marker.getLatLng();
        try {
            const resp = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.lat}&longitude=${pos.lng}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,wind_gusts_10m,wind_direction_10m,surface_pressure,visibility,weather_code&hourly=temperature_2m,weather_code,precipitation_probability,surface_pressure&daily=sunrise,sunset,weather_code,temperature_2m_max&timezone=auto`);
            const data = await resp.json();
            const h = new Date().getHours();
            
            currentData.vSol = data.current.wind_speed_10m;
            currentData.gSol = data.current.wind_gusts_10m;
            currentData.windDir = data.current.wind_direction_10m;
            currentData.tSol = data.current.temperature_2m;
            currentData.humSol = data.current.relative_humidity_2m;

            document.getElementById('hum-val').innerText = currentData.humSol + "%";
            document.getElementById('rain-prob').innerText = (data.hourly.precipitation_probability[h] || 0) + "%";
            document.getElementById('visibility-val').innerText = (data.current.visibility/1000).toFixed(1) + "km";
            document.getElementById('pressure-val').innerText = Math.round(data.current.surface_pressure);
            document.getElementById('main-temp-val').innerText = Math.round(currentData.tSol);
            document.getElementById('kp-val').innerText = (1.1 + Math.random() * 0.4).toFixed(1);

            const prevP = data.hourly.surface_pressure[h-1] || data.current.surface_pressure;
            const trendEl = document.getElementById('pressure-trend');
            trendEl.innerText = data.current.surface_pressure > prevP + 0.2 ? "‚Üë" : (data.current.surface_pressure < prevP - 0.2 ? "‚Üì" : "‚Üí");
            trendEl.style.color = trendEl.innerText === "‚Üë" ? "var(--green)" : (trendEl.innerText === "‚Üì" ? "var(--red)" : "var(--accent)");

            const fCont = document.getElementById('forecast-3h'); fCont.innerHTML = '';
            for(let i=1; i<=3; i++) {
                fCont.innerHTML += `<div style="text-align:center;"><div>${(h+i)%24}h</div><div style="font-size:18px">${wIcons[data.hourly.weather_code[h+i]]||"‚òÄÔ∏è"}</div><div>${Math.round(data.hourly.temperature_2m[h+i])}¬∞</div></div>`;
            }

            const wCont = document.getElementById('week-container'); wCont.innerHTML = '';
            data.daily.time.forEach((t, i) => {
                let d = new Date(t);
                wCont.innerHTML += `<div class="week-row"><span>${d.getDate()}/${d.getMonth()+1}</span> <span>${wIcons[data.daily.weather_code[i]]||"‚òÄÔ∏è"}</span> <span style="color:var(--red)">${Math.round(data.daily.temperature_2m_max[i])}¬∞</span></div>`;
            });
            
            const dp = Math.round(currentData.tSol - ((100-currentData.humSol)/5));
            document.getElementById('dp-val').innerText = dp + "¬∞";
            document.getElementById('cloud-base').innerText = Math.round((currentData.tSol - dp) * 122) + "m";
            
            runAnalysis();
            document.getElementById('wind-needle').style.transform = `rotate(${currentData.windDir}deg)`;
        } catch(e) { console.error(e); }
    }

    function runAnalysis() {
        const h = parseInt(document.getElementById('h-slider').value);
        document.getElementById('h-label').innerText = h;
        const factor = Math.pow((h + 10) / 10, 0.14);
        const vAlt = Math.round(currentData.vSol * factor);
        const gAlt = Math.round(currentData.gSol * factor);
        
        const vEl = document.getElementById('v-alt-val');
        const gEl = document.getElementById('v-gust-val');
        const sTxt = document.getElementById('status-txt');
        const sCard = document.getElementById('status-card');
        
        vEl.innerText = `${vAlt} km/h`; gEl.innerText = `Rafales: ${gAlt} km/h`;
        
        if (vAlt >= 45 || gAlt >= 50) {
            sTxt.innerText = "üö´ DANGER"; sTxt.style.color = "var(--red)"; sCard.style.borderLeftColor = "var(--red)";
            vEl.style.color = "var(--red)"; gEl.style.color = "var(--red)";
        } else if (vAlt >= 30 || gAlt >= 35) {
            sTxt.innerText = "‚ö†Ô∏è ATTENTION"; sTxt.style.color = "var(--orange)"; sCard.style.borderLeftColor = "var(--orange)";
            vEl.style.color = "var(--orange)"; gEl.style.color = "var(--orange)";
        } else {
            sTxt.innerText = "üõ°Ô∏è OP√âRATIONNEL"; sTxt.style.color = "var(--green)"; sCard.style.borderLeftColor = "var(--green)";
            vEl.style.color = "var(--text)"; gEl.style.color = "var(--sub)";
        }
    }

    async function toggleRadar() {
        const btn = document.getElementById('radar-btn-ui');
        if (radarLayer) { map.removeLayer(radarLayer); radarLayer = null; btn.innerText = "üì° Radar"; return; }
        try {
            const resp = await fetch('https://api.rainviewer.com/public/weather-maps.json');
            const data = await resp.json();
            const lastTime = data.radar.past[data.radar.past.length - 1].time;
            radarLayer = L.tileLayer(`https://tilecache.rainviewer.com/v2/radar/${lastTime}/256/{z}/{x}/{y}/2/1_1.png`, { 
                opacity: 0.65, 
                zIndex: 1000 
            });
            radarLayer.addTo(map);
            btn.innerText = "üì° Radar OFF";
        } catch(e) { alert("Erreur Radar"); }
    }

    function toggleChecklist() {
        const m = document.getElementById('checklist-modal');
        m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
    }

    function showPage(p) {
        document.getElementById('page-now').style.display = p === 'now' ? 'block' : 'none';
        document.getElementById('page-week').style.display = p === 'week' ? 'block' : 'none';
        document.getElementById('page-aero').style.display = p === 'aero' ? 'block' : 'none';
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + p).classList.add('active');
        if(p === 'now') setTimeout(() => map.invalidateSize(), 200);
    }

    function initLocation() { navigator.geolocation.getCurrentPosition(pos => { const p = [pos.coords.latitude, pos.coords.longitude]; marker.setLatLng(p); map.setView(p, 13); fetchWeatherData(); }, () => fetchWeatherData()); }
    function openExternalGouv() { window.open(`https://carte.gouv.fr/carte/acces-aux-donnees-de-la-geoplateforme?c=${marker.getLatLng().lng},${marker.getLatLng().lat}&z=12&l=GEOGRAPHICALGRIDSYSTEMS.MAPS.SCAN-OACI(1)`, '_blank'); }
    function openExternalVAC() { window.open(`https://www.sia.aviation-civile.gouv.fr/vaip`, '_blank'); }
    function openExternalNOTAM() { window.open(`https://notaminfo.com/francemap?lat=${marker.getLatLng().lat}&lon=${marker.getLatLng().lng}&zoom=11`, '_blank'); }
    function openExternalSUP() { window.open(`https://www.sia.aviation-civile.gouv.fr/documents/supaip/aip/id/80`, '_blank'); }
    function openExternalAZBA() { window.open(`https://www.sia.aviation-civile.gouv.fr/schedules`, '_blank'); }
    function openExternalCarto() { window.open(`https://www.cartoradio.fr/index.html#/carto/lonlat/${marker.getLatLng().lng}/${marker.getLatLng().lat}`, '_blank'); }
    function openExternalOpenAIP() { window.open(`https://www.openaip.net/map?lat=${marker.getLatLng().lat}&lon=${marker.getLatLng().lng}&zoom=11`, '_blank'); }
</script>
</body>
</html>
